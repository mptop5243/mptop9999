<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>RFID åˆ·å¡ä¸Šå‚³èˆ‡æŸ¥è©¢</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.0/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      text-align: center;
      font-family: Arial, sans-serif;
      padding: 30px;
    }

    input, button {
      font-size: 20px;
      margin: 10px;
      padding: 10px;
    }

    #rfidInput, #studentIdInput, #studentIdQueryInput {
      font-size: 40px;
      width: 60%;
    }

    #status {
      font-size: 80px;
      font-weight: bold;
      margin-top: 40px;
    }

    .found { color: blue; }
    .not-found { color: red; }
    .error { color: orange; }

    #recordsTable {
      margin-top: 40px;
      width: 100%;
      border-collapse: collapse;
      font-size: 20px;
    }

    #recordsTable th, #recordsTable td {
      border: 1px solid #999;
      padding: 10px;
    }

    #recordsTable th {
      background-color: #eee;
    }

    .input-section {
      margin-bottom: 20px;
    }
    
    .latest-record {
      background-color: #ffffcc;
    }

    #wordContainer {
      margin-top: 20px;
      border: 1px solid #ccc;
      padding: 10px;
      max-width: 100%;
      overflow: auto;
      text-align: left;
    }

    #wordViewer {
      width: 100%;
      min-height: 500px;
      padding: 20px;
      background-color: white;
    }

    .highlight-name {
      background-color: yellow;
      border: 2px solid red;
      border-radius: 3px;
      padding: 0 2px;
    }

    .word-controls {
      margin: 15px 0;
    }

    /* ä¿ç•™WordåŸå§‹æ¨£å¼ */
    .word-content {
      font-family: inherit;
      white-space: normal;
    }
    .word-content p {
      margin: 0;
      padding: 0;
    }
    .word-content table {
      border-collapse: collapse;
      width: 100%;
    }
    .word-content table, .word-content th, .word-content td {
      border: 1px solid black;
    }
    
    .query-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
  </style>
</head>
<body>
  <h1>å—å±±ä¸­å­¸ç”Ÿæ´»æ•™è‚²åˆ·å¡ç³»çµ±</h1>
  
  <div class="input-section">
    <h2>ğŸ”– RFIDåˆ·å¡</h2>
    <input type="text" id="rfidInput" autofocus placeholder="è«‹åˆ·å¡" />
  </div>
  
  <div class="input-section">
    <h2>ğŸ†” å­¸è™Ÿè¼¸å…¥</h2>
    <input type="text" id="studentIdInput" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ" />
    <button onclick="submitStudentId()">æäº¤</button>
  </div>
  
  <p id="status"></p>

  <audio id="successSound" src="success.mp3" preload="auto"></audio>
  <audio id="errorSound" src="error.mp3" preload="auto"></audio>

  <hr />
  <h2>ğŸ“„ ä¸Šå‚³ç”Ÿæ•™åå†ŠWordæª”</h2>
  <input type="file" id="wordUpload" accept=".docx,.doc" />
  <button onclick="loadWord()">è¼‰å…¥Wordæª”</button>
  
  <div id="wordContainer" style="display: none;">
    <div class="word-controls">
      <button onclick="downloadMarkedRoster()">ä¸‹è¼‰å·²æ¨™è¨˜åå†Š</button>
      <span id="downloadStatus"></span>
    </div>
    <h3>åå†Šé è¦½</h3>
    <div id="wordViewer" class="word-content"></div>
  </div>

  <hr />
  <h2>ğŸ“… æŸ¥è©¢åˆ·å¡ç´€éŒ„</h2>
  
  <div class="query-section">
    <h3>ä¾æ—¥æœŸæŸ¥è©¢</h3>
    <input type="date" id="queryDate" />
    <button onclick="queryRecordsByDate()">æŸ¥è©¢</button>
  </div>
  
  <div class="query-section">
    <h3>ä¾å­¸è™ŸæŸ¥è©¢</h3>
    <input type="text" id="studentIdQueryInput" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ" />
    <button onclick="queryRecordsByStudentId()">æŸ¥è©¢</button>
    <button onclick="clearStudentIdQuery()">æ¸…é™¤</button>
  </div>
  
  <button onclick="window.print()">åˆ—å°</button>

  <table id="recordsTable">
    <thead>
      <tr>
        <th>ç­ç´š</th>
        <th>å­¸è™Ÿ</th>
        <th>å§“å</th>
        <th>åˆ·å¡æ™‚é–“</th>
        <th>é¡å‹</th>
      </tr>
    </thead>
    <tbody id="recordsBody">
    </tbody>
  </table>

  <script>
    const { jsPDF } = window.jspdf;

    const firebaseConfig = {
      apiKey: "AIzaSyDIBZcv7FDus86I_tqMNdGaTGLFUH9TkGg",
      authDomain: "new123-88a1a.firebaseapp.com",
      databaseURL: "https://new123-88a1a-default-rtdb.firebaseio.com",
      projectId: "new123-88a1a",
      storageBucket: "new123-88a1a.appspot.com",
      messagingSenderId: "1098459270837",
      appId: "1:1098459270837:web:51532d8f2cffbf9271b8fc"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const rfidInput = document.getElementById("rfidInput");
    const studentIdInput = document.getElementById("studentIdInput");
    const studentIdQueryInput = document.getElementById("studentIdQueryInput");
    const status = document.getElementById("status");
    const successSound = document.getElementById("successSound");
    const errorSound = document.getElementById("errorSound");
    const wordContainer = document.getElementById("wordContainer");
    const wordViewer = document.getElementById("wordViewer");
    const downloadStatus = document.getElementById("downloadStatus");

    let clearTimer = null;
    let latestRecordId = null;
    let highlightedNames = new Set();
    let originalWordHtml = "";
    let currentQueryType = "date"; // "date" æˆ– "studentId"

    // RFIDåˆ·å¡è™•ç†
    rfidInput.addEventListener("keydown", async function (event) {
      if (event.key === "Enter") {
        const rfid = rfidInput.value.trim();
        if (rfid !== "") {
          await processInput(rfid, "rfid");
        }
      }
    });

    // å­¸è™Ÿè¼¸å…¥è™•ç†
    studentIdInput.addEventListener("keydown", async function (event) {
      if (event.key === "Enter") {
        await submitStudentId();
      }
    });

    // å­¸è™ŸæŸ¥è©¢è¼¸å…¥è™•ç†
    studentIdQueryInput.addEventListener("keydown", async function (event) {
      if (event.key === "Enter") {
        await queryRecordsByStudentId();
      }
    });

    // å­¸è™Ÿæäº¤è™•ç†
    async function submitStudentId() {
      const studentId = studentIdInput.value.trim();
      if (studentId !== "") {
        await processInput(studentId, "studentId");
      }
    }

    // é€šç”¨è¼¸å…¥è™•ç†å‡½æ•¸
    async function processInput(inputValue, inputType) {
      try {
        let querySnapshot;
        let studentName = null;
        
        if (inputType === "rfid") {
          querySnapshot = await db.collection("students").where("rfid", "==", inputValue).get();
        } else {
          querySnapshot = await db.collection("students").where("studentId", "==", inputValue).get();
        }
        
        status.className = "";
        clearTimeout(clearTimer);

        if (!querySnapshot.empty) {
          const data = querySnapshot.docs[0].data();
          studentName = data.name;
          status.textContent = `ç­ç´šï¼š${data.class}ï¼Œå­¸è™Ÿï¼š${data.studentId}ï¼Œå§“åï¼š${data.name}`;
          status.classList.add("found");
          successSound.play();

          const docRef = await db.collection("rfid_records").add({
            rfid: data.rfid || null,
            class: data.class,
            studentId: data.studentId,
            name: data.name,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            inputType: inputType
          });
          latestRecordId = docRef.id;
        } else {
          status.textContent = `æŸ¥ç„¡è³‡æ–™ï¼Œ${inputType === "rfid" ? "RFID" : "å­¸è™Ÿ"}ï¼š${inputValue}`;
          status.classList.add("not-found");
          errorSound.play();

          const docRef = await db.collection("rfid_records").add({
            rfid: inputType === "rfid" ? inputValue : null,
            class: null,
            studentId: inputType === "studentId" ? inputValue : null,
            name: null,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            inputType: inputType
          });
          latestRecordId = docRef.id;
        }

        if (studentName && wordViewer.innerHTML) {
          const wordContent = wordViewer.innerHTML;
          if (wordContent.includes(studentName)) {
            highlightNameInWord(studentName);
          } else {
            status.textContent = `(å­¸ç”Ÿæœ¬æ—¥ç„¡ç”Ÿæ•™)`;
            status.className = "not-found";
            errorSound.play();
          }
        }

        // æ ¹æ“šç•¶å‰æŸ¥è©¢é¡å‹åˆ·æ–°è¨˜éŒ„
        if (currentQueryType === "date") {
          await queryRecordsByDate();
        } else {
          await queryRecordsByStudentId();
        }

        clearTimer = setTimeout(() => {
          status.textContent = "";
          status.className = "";
        }, 3000);

        if (inputType === "rfid") {
          rfidInput.value = "";
          rfidInput.focus();
        } else {
          studentIdInput.value = "";
          studentIdInput.focus();
        }
      } catch (error) {
        status.textContent = "æ“ä½œå¤±æ•—ï¼š" + error.message;
        status.className = "error";
        errorSound.play();

        clearTimer = setTimeout(() => {
          status.textContent = "";
          status.className = "";
        }, 3000);
      }
    }

    // ä¾æ—¥æœŸæŸ¥è©¢è¨˜éŒ„
    async function queryRecordsByDate() {
      currentQueryType = "date";
      const dateStr = document.getElementById("queryDate").value;
      if (!dateStr) {
        const today = new Date();
        const dateInput = document.getElementById("queryDate");
        dateInput.valueAsDate = today;
        return await queryRecordsByDate();
      }

      const date = new Date(dateStr);
      const start = new Date(date.setHours(0, 0, 0, 0));
      const end = new Date(date.setHours(23, 59, 59, 999));

      const snapshot = await db.collection("rfid_records")
        .where("timestamp", ">=", start)
        .where("timestamp", "<=", end)
        .orderBy("timestamp", "desc")
        .get();

      displayRecords(snapshot);
    }

    // ä¾å­¸è™ŸæŸ¥è©¢è¨˜éŒ„
    async function queryRecordsByStudentId() {
      currentQueryType = "studentId";
      const studentId = studentIdQueryInput.value.trim();
      
      if (!studentId) {
        alert("è«‹è¼¸å…¥å­¸è™Ÿ");
        return;
      }

      try {
        const snapshot = await db.collection("rfid_records")
          .where("studentId", "==", studentId)
          .orderBy("timestamp", "desc")
          .get();

        if (snapshot.empty) {
          status.textContent = `æŸ¥ç„¡å­¸è™Ÿ ${studentId} çš„åˆ·å¡è¨˜éŒ„`;
          status.className = "not-found";
          setTimeout(() => {
            status.textContent = "";
            status.className = "";
          }, 3000);
        }

        displayRecords(snapshot);
      } catch (error) {
        console.error("æŸ¥è©¢å¤±æ•—:", error);
        status.textContent = "æŸ¥è©¢å¤±æ•—ï¼š" + error.message;
        status.className = "error";
        setTimeout(() => {
          status.textContent = "";
          status.className = "";
        }, 3000);
      }
    }

    // æ¸…é™¤å­¸è™ŸæŸ¥è©¢
    function clearStudentIdQuery() {
      studentIdQueryInput.value = "";
      currentQueryType = "date";
      queryRecordsByDate();
    }

    // é¡¯ç¤ºè¨˜éŒ„
    function displayRecords(snapshot) {
      const tbody = document.getElementById("recordsBody");
      tbody.innerHTML = "";

      snapshot.forEach(doc => {
        const data = doc.data();
        const time = data.timestamp?.toDate().toLocaleString("zh-TW") || "ç„¡æ™‚é–“";
        const inputType = data.inputType === "rfid" ? "RFIDåˆ·å¡" : "å­¸è™Ÿè¼¸å…¥";

        const row = document.createElement("tr");
        if (doc.id === latestRecordId) {
          row.classList.add("latest-record");
        }
        row.innerHTML = `
          <td>${data.class || ""}</td>
          <td>${data.studentId || ""}</td>
          <td>${data.name || ""}</td>
          <td>${time}</td>
          <td>${inputType}</td>
        `;
        tbody.appendChild(row);
      });
      
      latestRecordId = null;
    }

    // è¼‰å…¥Wordæ–‡ä»¶ä¸¦ä¿ç•™æ ¼å¼
    async function loadWord() {
      const fileInput = document.getElementById("wordUpload");
      const file = fileInput.files[0];
      
      if (!file) {
        alert("è«‹å…ˆé¸æ“‡Wordæ–‡ä»¶");
        return;
      }

      try {
        downloadStatus.textContent = "æ­£åœ¨è¼‰å…¥Wordæª”...";
        
        const arrayBuffer = await file.arrayBuffer();
        
        // ä½¿ç”¨mammoth.jså°‡Wordè½‰æ›ç‚ºHTMLä¸¦ä¿ç•™æ ¼å¼
        const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
        
        // ä¿å­˜åŸå§‹HTMLä»¥ä¾¿é‡æ–°æ¨™è¨˜
        originalWordHtml = result.value;
        
        // é¡¯ç¤ºè½‰æ›å¾Œçš„HTML
        wordViewer.innerHTML = originalWordHtml;
        highlightedNames.clear();
        
        wordContainer.style.display = "block";
        downloadStatus.textContent = "Wordæª”è¼‰å…¥å®Œæˆï¼";
        
        setTimeout(() => {
          downloadStatus.textContent = "";
        }, 3000);
      } catch (error) {
        console.error("Wordæª”è¼‰å…¥å¤±æ•—:", error);
        downloadStatus.textContent = "Wordæª”è¼‰å…¥å¤±æ•—: " + error.message;
      }
    }

    // åœ¨Wordå…§å®¹ä¸­é«˜äº®é¡¯ç¤ºå§“åï¼ˆä¿ç•™åŸå§‹æ ¼å¼ï¼‰
    function highlightNameInWord(name) {
      if (highlightedNames.has(name)) {
        return;
      }
      
      // é‡ç½®ç‚ºåŸå§‹HTML
      wordViewer.innerHTML = originalWordHtml;
      
      // æ¨™è¨˜æ‰€æœ‰æ‰¾åˆ°çš„å§“å
      const regex = new RegExp(escapeRegExp(name), "g");
      wordViewer.innerHTML = wordViewer.innerHTML.replace(
        regex, 
        `<span class="highlight-name">${name}</span>`
      );
      
      highlightedNames.add(name);
      
      // æ›´æ–°åŸå§‹HTMLä»¥åŒ…å«æ–°çš„æ¨™è¨˜
      originalWordHtml = wordViewer.innerHTML;
    }

    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // ä¸‹è¼‰å·²æ¨™è¨˜çš„åå†Š
    async function downloadMarkedRoster() {
      if (!wordViewer || wordViewer.innerHTML === "") {
        downloadStatus.textContent = "æ²’æœ‰å¯ä¸‹è¼‰çš„åå†Š";
        return;
      }

      downloadStatus.textContent = "æ­£åœ¨ç”Ÿæˆæª”æ¡ˆ...";
      
      try {
        // å‰µå»º Blob å°è±¡ (HTMLæ ¼å¼)
        const content = `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>å·²æ¨™è¨˜åå†Š</title>
            <style>
              body { font-family: "Microsoft JhengHei", Arial, sans-serif; }
              table { border-collapse: collapse; width: 100%; }
              th, td { border: 1px solid black; padding: 5px; text-align: center; }
              .highlight-name { background-color: yellow; border: 2px solid red; }
            </style>
          </head>
          <body>
            ${wordViewer.innerHTML}
          </body>
          </html>
        `;
        
        // å‰µå»ºä¸‹è¼‰é€£çµ
        const blob = new Blob([content], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `å·²æ¨™è¨˜åå†Š_${new Date().toLocaleDateString('zh-TW')}.html`;
        document.body.appendChild(a);
        a.click();
        
        // æ¸…ç†
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          downloadStatus.textContent = "ä¸‹è¼‰å®Œæˆï¼";
          setTimeout(() => { downloadStatus.textContent = ""; }, 3000);
        }, 100);
      } catch (error) {
        console.error("ç”Ÿæˆæª”æ¡ˆå¤±æ•—:", error);
        downloadStatus.textContent = "ä¸‹è¼‰å¤±æ•—: " + error.message;
      }
    }

    window.onload = function() {
      queryRecordsByDate();
    };
  </script>
</body>
</html>
